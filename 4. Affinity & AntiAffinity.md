# Affinity & AntiAffinity
- Taint와 Toleration은 특정 노드에 Pod 스케줄링을 피하거나 감수하고 실행하는 정책에 집중했다면 Affinity와 AntiAffinity는 특정 Node나 Pod와의 거리를 조절하는데 사용함

## Affinity
- 친밀함이라는 뜻으로 Pod끼리 서로 가까이 스케줄링되고 싶은 경우, Pod가 특정 Node에 할당되길 원할 때 사용

## AntiAffinity
- 반-친밀함이라는 뜻으로 서로 멀리 스케줄링 되고 싶은 경우 사용함

<br><br>

### 사용 예시
| 조건 | Affinity 유형 | 사용 예시 |
|------|--------------|----------|
| 특정 노드에 배치하고 싶을 때 | Node Affinity | 특정 노드(Label이 있는 노드)에만 배포 (예: GPU가 있는 노드) |
| 특정 노드를 피하고 싶을 때 | Node AntiAffinity | 특정 노드(Label이 있는 노드)를 피해서 배포 |
| 특정 파드와 함께 배치하고 싶을 때 | Pod Affinity | 동일한 애플리케이션의 관련 파드끼리 가까이 배치 (예: 웹 서버와 캐시 서버) |
| 특정 파드를 피해 배치하고 싶을 때 | Pod AntiAffinity | 동일한 애플리케이션의 파드가 서로 다른 노드에 분산 배치 (예: 중복된 파드가 같은 노드에 몰리지 않도록) |


<br><br>

## Node Affinity
- Pod가 특정 Node에 할당되길 원할 때 사용함
### 실습
### 1. 노드에 라벨 추가 (테스트 환경에 따라 적절한 노드 이름을 입력)
```
kubectl label nodes <노드이름1> disktype=ssd
kubectl label nodes <노드이름2> disktype=hdd
```

### 2. Node Affinity 적용 테스트
```
kubectl apply -f node-affinity.yaml
kubectl get pods -o wide  # 특정 노드(disktype=ssd)에 배치되었는지 확인
```

### 3. Node AntiAffinity 적용 테스트
```
kubectl apply -f node-anti-affinity.yaml
kubectl get pods -o wide  # 특정 노드(disktype=hdd)를 피했는지 확인
```

### 4. Pod Affinity 적용 테스트
```
kubectl apply -f pod-affinity.yaml
kubectl get pods -o wide  # 같은 노드에 배치되었는지 확인
```

### 5. Pod AntiAffinity 적용 테스트
```
kubectl apply -f pod-anti-affinity.yaml
kubectl get pods -o wide  # 서로 다른 노드에 분산 배치되었는지 확인
```






node affinity 배포<br>
``` kubectl apply -f node-affinity.yaml```
<details>
  <summary>node-affinity.yaml</summary>

```
# node-affinity.yaml
apiVersion: v1
kind: Pod
metadata:
  name: node-affinity
spec:
  containers:
  - name: nginx
    image: nginx
  affinity:
    nodeAffinity: #affinity 종류를 선택함
      requiredDuringSchedulingIgnoredDuringExecution: # 특정 노드에 스케줄링 되길 강제한다, 희망하는건 preferredDuring~~~
        nodeSelectorTerms: # 선택할 노드의 라벨 정보
        - matchExpressions: # 매칭 조건 설정
          - key: disktype
            operator: In # NotIn, Exists 등등의 옵션이 있음. In은 지정한 값이 하나라도 해당하면 이라는 의미임, 노드 labal이 disktype이고 label의 값이 ssd, nvme 중 하나라도 만족
            values:
              - ssd
              - nvme
```
</details>

